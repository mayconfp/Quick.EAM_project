<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha</title>
    <script>
        function showSection(sectionId) {
            document.getElementById('request-reset').style.display = 'none';
            document.getElementById('verify-code').style.display = 'none';
            document.getElementById('reset-password').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }
        
        async function submitForm(event, formId, actionUrl, nextSectionId) {
            event.preventDefault();
            let form = document.getElementById(formId);
            let formData = new FormData(form);
        
            // 游댠 Se for a etapa de solicita칞칚o do c칩digo, salvar o e-mail no sessionStorage
            if (formId === 'request-reset-form') {
                let emailInput = form.querySelector('input[name="email"]');
                sessionStorage.setItem('reset_email', emailInput.value);
            }
        
            // 游댠 Se for a etapa de valida칞칚o do c칩digo, garantir que o e-mail seja enviado
            if (formId === 'verify-code-form') {
                let storedEmail = sessionStorage.getItem('reset_email');
                formData.append('email', storedEmail);
            }
        
            // 游댠 Se for a etapa de redefini칞칚o de senha, garantir que o e-mail e c칩digo sejam enviados
            if (formId === 'reset-password-form') {
                let storedEmail = sessionStorage.getItem('reset_email');
                let storedCode = sessionStorage.getItem('reset_code');
                formData.append('email', storedEmail);
                formData.append('code', storedCode);
            }
        
            try {
                let response = await fetch(actionUrl, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });
        
                let result = await response.json();
                
                // 游댠 Se a resposta for sucesso, verifica se h치 redirecionamento
                if (result.success) {
                    if (formId === 'verify-code-form') {
                        sessionStorage.setItem('reset_code', form.querySelector('input[name="code"]').value);
                    }
                    
                    // 游댠 Se houver uma URL de redirecionamento, redireciona imediatamente
                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                        return; // Interrompe a execu칞칚o ap칩s o redirecionamento
                    }
        
                    showSection(nextSectionId);
                } else {
                    alert(result.message);
                }
        
            } catch (error) {
                console.error("Erro na requisi칞칚o:", error);
                alert("Erro ao enviar a requisi칞칚o. Tente novamente.");
            }
        }
    </script>
</head>
<body>
    {% include 'usuarios/partials/nav.html'%}

    <div id="message-box" style="display:none;"></div>

    <!-- Etapa 1: Solicitar c칩digo -->
    <div id="request-reset">
        <h2>Esqueceu sua senha?</h2>
        <form id="request-reset-form" onsubmit="submitForm(event, 'request-reset-form', '{% url 'password_reset_request' %}', 'verify-code')">
            {% csrf_token %}
            <input type="email" name="email" placeholder="Digite seu e-mail" required>
            <button type="submit">Enviar C칩digo</button>
        </form>
    </div>

    <!-- Etapa 2: Verificar c칩digo -->
    <div id="verify-code" style="display:none;">
        <h2>Digite o c칩digo enviado para seu e-mail</h2>
        <form id="verify-code-form" onsubmit="submitForm(event, 'verify-code-form', '{% url 'validate_reset_code' %}', 'reset-password')">
            {% csrf_token %}
            <input type="text" name="code" placeholder="Digite o c칩digo" required>
            <button type="submit">Verificar C칩digo</button>
        </form>
    </div>

    <!-- Etapa 3: Redefinir senha -->
    <div id="reset-password" style="display:none;">
        <h2>Definir Nova Senha</h2>
        <form id="reset-password-form" onsubmit="submitForm(event, 'reset-password-form', '{% url 'password_reset_confirm' %}', '')">
            {% csrf_token %}
            <input type="hidden" name="email" value="{{ email }}">  <!-- 游댠 Adiciona o e-mail -->
            <input type="hidden" name="code" value="{{ code }}">  <!-- 游댠 Adiciona o c칩digo -->
        
            <input type="password" name="password" placeholder="Nova senha" required>
            <input type="password" name="confirm_password" placeholder="Confirme a senha" required>
        
            <button type="submit">Redefinir Senha</button>
        </form>
    </div>

</body>
</html>
